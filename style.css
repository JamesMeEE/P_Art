function doGet(e) {
  const params = e.parameter;
  const action = params.action;
  
  try {
    const ss = SpreadsheetApp.openById('1FF4odviKZ2LnRvPf8ltM0o_jxM0ZHuJHBlkQCjC3sxA');
    
    if (action === 'UPDATE_PRICING') {
      const sheet = getOrCreateSheet(ss, 'Pricing', ['Sell_1Baht', 'Last_Update']);
      if (sheet.getLastRow() > 1) {
        sheet.getRange(2, 1).setValue(params.sell1Baht);
        sheet.getRange(2, 2).setValue(new Date());
      } else {
        sheet.appendRow([params.sell1Baht, new Date()]);
      }
      return createResponse(true, 'อัพเดทราคาสำเร็จ');
    }
    
    if (action === 'ADD_SALE') {
      const sheet = getOrCreateSheet(ss, 'Sales', ['ID', 'Customer', 'Product', 'Amount', 'Price', 'Date', 'Status', 'Created By']);
      const id = 'SALE' + new Date().getTime();
      sheet.appendRow([id, params.customer, params.product, params.amount, params.price, new Date(), 'PENDING', params.user]);
      return createResponse(true, 'สร้างรายการขายสำเร็จ');
    }
    
    if (action === 'ADD_BUYBACK') {
      const sheet = getOrCreateSheet(ss, 'Buyback', ['ID', 'Customer', 'Product', 'Amount', 'Price', 'Date', 'Status', 'Created By']);
      const id = 'BUY' + new Date().getTime();
      sheet.appendRow([id, params.customer, params.product, params.amount, params.price, new Date(), 'PENDING', params.user]);
      return createResponse(true, 'สร้างรายการรับซื้อสำเร็จ');
    }
    
    if (action === 'APPROVE_ITEM') {
      if (params.type === 'SALE') {
        const sheet = ss.getSheetByName('Sales');
        updateStatus(sheet, params.id, 'READY');
        return createResponse(true, 'อนุมัติสำเร็จ');
      } else if (params.type === 'BUYBACK') {
        const sheet = ss.getSheetByName('Buyback');
        updateStatus(sheet, params.id, 'COMPLETED');
        const row = findRow(sheet, params.id);
        if (row) {
          const productId = sheet.getRange(row, 3).getValue();
          const amount = sheet.getRange(row, 4).getValue();
          updateStock(ss, productId, parseInt(amount));
        }
        return createResponse(true, 'อนุมัติและเพิ่มสต็อกสำเร็จ');
      } else if (params.type === 'WITHDRAW') {
        const sheet = ss.getSheetByName('Inventory');
        updateStatus(sheet, params.id, 'COMPLETED');
        const row = findRow(sheet, params.id);
        if (row) {
          const productId = sheet.getRange(row, 2).getValue();
          const quantity = sheet.getRange(row, 4).getValue();
          updateStock(ss, productId, -parseInt(quantity));
        }
        return createResponse(true, 'อนุมัติและตัดสต็อกสำเร็จ');
      }
    }
    
    if (action === 'REJECT_ITEM') {
      if (params.type === 'SALE') {
        const sheet = ss.getSheetByName('Sales');
        updateStatus(sheet, params.id, 'REJECTED');
      } else if (params.type === 'BUYBACK') {
        const sheet = ss.getSheetByName('Buyback');
        updateStatus(sheet, params.id, 'REJECTED');
      } else if (params.type === 'WITHDRAW') {
        const sheet = ss.getSheetByName('Inventory');
        updateStatus(sheet, params.id, 'REJECTED');
      }
      return createResponse(true, 'ไม่อนุมัติสำเร็จ');
    }
    
    if (action === 'CONFIRM_SALE') {
      const sheet = ss.getSheetByName('Sales');
      const row = findRow(sheet, params.id);
      if (row) {
        const productId = sheet.getRange(row, 3).getValue();
        const amount = sheet.getRange(row, 4).getValue();
        updateStock(ss, productId, -parseInt(amount));
        updateStatus(sheet, params.id, 'COMPLETED');
        return createResponse(true, 'ยืนยันและตัดสต็อกสำเร็จ');
      }
      return createResponse(false, 'ไม่พบรายการ');
    }
    
    if (action === 'ADD_WITHDRAW') {
      const sheet = getOrCreateSheet(ss, 'Inventory', ['ID', 'Product', 'Type', 'Quantity', 'Cost', 'Date', 'Status', 'Created By']);
      const id = 'WD' + new Date().getTime();
      sheet.appendRow([id, params.product, 'WITHDRAW', params.quantity, '', new Date(), 'PENDING', params.user]);
      return createResponse(true, 'สร้างคำขอเบิกสำเร็จ');
    }
    
    if (action === 'ADD_STOCK_IN') {
      const sheet = getOrCreateSheet(ss, 'Inventory', ['ID', 'Product', 'Type', 'Quantity', 'Cost', 'Date', 'Status', 'Created By']);
      const id = 'SI' + new Date().getTime();
      sheet.appendRow([id, params.product, 'STOCK_IN', params.quantity, params.cost, new Date(), 'COMPLETED', params.user]);
      updateStock(ss, params.product, parseInt(params.quantity));
      return createResponse(true, 'เพิ่มสต็อกสำเร็จ');
    }
    
    if (action === 'ADD_STOCK_OUT') {
      const sheet = getOrCreateSheet(ss, 'Inventory', ['ID', 'Product', 'Type', 'Quantity', 'Cost', 'Date', 'Status', 'Created By']);
      const id = 'SO' + new Date().getTime();
      sheet.appendRow([id, params.product, 'STOCK_OUT', params.quantity, '', new Date(), 'COMPLETED', params.user]);
      updateStock(ss, params.product, -parseInt(params.quantity));
      return createResponse(true, 'บันทึกสูญหายสำเร็จ');
    }
    
    return createResponse(false, 'Invalid action');
    
  } catch (error) {
    return createResponse(false, error.toString());
  }
}

function doPost(e) {
  return doGet(e);
}

function getOrCreateSheet(ss, name, headers) {
  let sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
    sheet.appendRow(headers);
  } else if (sheet.getLastRow() === 0) {
    sheet.appendRow(headers);
  }
  return sheet;
}

function findRow(sheet, id) {
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === id) {
      return i + 1;
    }
  }
  return null;
}

function updateStatus(sheet, id, status) {
  const row = findRow(sheet, id);
  if (row) {
    sheet.getRange(row, 7).setValue(status);
  }
}

function updateStock(ss, productId, change) {
  const sheet = getOrCreateSheet(ss, 'Stock', ['Product_ID', 'Stock']);
  const row = findRowByColumn(sheet, productId, 1);
  if (row) {
    const currentStock = sheet.getRange(row, 2).getValue();
    sheet.getRange(row, 2).setValue(parseInt(currentStock) + change);
  } else {
    sheet.appendRow([productId, change]);
  }
}

function findRowByColumn(sheet, value, column) {
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][column - 1] === value) {
      return i + 1;
    }
  }
  return null;
}

function createResponse(success, message, data) {
  const response = {
    success: success,
    message: message
  };
  if (data) {
    response.data = data;
  }
  return ContentService.createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON);
}
